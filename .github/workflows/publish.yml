name: Publish

on:
  push:
    tags:
      - v*.*.*

jobs:
  pre-publish-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Cache Cargo dependencies
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
      - name: Setup integration test
        working-directory: tests/data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo jpreprocess/open_jtalk v0.0.5
          chmod +x openjtalk_bin

          gh release download --repo jpreprocess/jpreprocess v0.0.1-rc0
          tar xJvf lindera.tar.xz
          tar xJvf mecab-naist-jdic.tar.xz

          rm *.tar.gz *.tar.xz
      - name: Build
        run: cargo build --verbose --all-features
      - name: Run tests
        run: cargo test --verbose --all-features -- --include-ignored
      - name: Run Clippy
        run: cargo clippy --all-targets

  check-prerelease:
    runs-on: ubuntu-latest
    outputs:
      release: ${{ steps.check-tag.outputs.release }}
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Check Tag
        id: check-tag
        run: |
          if [[ ${{ github.event.ref }} =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Not prerelease"
            echo "release=true" >> $GITHUB_OUTPUT
          else
            echo "Prerelease"
            echo "release=false" >> $GITHUB_OUTPUT
          fi

  build-binary:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            feature: []
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            feature: []
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
            feature: []
          - target: x86_64-apple-darwin
            os: macos-latest
            feature: []
          - target: aarch64-apple-darwin
            os: macos-latest
            feature: []
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            feature: ["naist-jdic"]
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            feature: ["naist-jdic"]
          - target: x86_64-pc-windows-gnu
            os: ubuntu-latest
            feature: ["naist-jdic"]
          - target: x86_64-apple-darwin
            os: macos-latest
            feature: ["naist-jdic"]
          - target: aarch64-apple-darwin
            os: macos-latest
            feature: ["naist-jdic"]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - uses: dtolnay/rust-toolchain@b3b07ba8b418998c39fb20f53e8b695cdcc8de1b # master
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Build
        run: |
          cargo install cross
          cross build --release --target=${{ matrix.target }} --features=binary,${{ join(matrix.feature, ',') }} --bin dict_tools --bin jpreprocess

      - name: Package
        shell: bash
        run: |
          TMP_NAME="${{ format('jpreprocess-{0}-{1}.tgz', matrix.target, join(matrix.feature, '-')) }}"
          NAME="${TMP_NAME/-.tgz/.tgz}"

          mkdir -p target/.jpreprocess_artifact/jpreprocess
          cp target/${{ matrix.target }}/release/{jpreprocess,dict_tools}${{ contains(matrix.target, 'windows') && '.exe' || '' }} target/.jpreprocess_artifact/jpreprocess

          tar czvf "$NAME" -C target/.jpreprocess_artifact jpreprocess

          rm -r target/.jpreprocess_artifact

      - name: Upload Artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: ${{ format('build-{0}-{1}', matrix.target, join(matrix.feature, '-')) }}
          path: "*.tgz"

  build-naist-jdic:
    runs-on: ubuntu-latest
    needs: [build-binary]
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          repository: jpreprocess/naist-jdic
          ref: v0.1.3
          path: naist-jdic-source
      - name: Download binary
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: build-x86_64-unknown-linux-gnu-
      - name: Build
        run: |
          tar xzvf jpreprocess-x86_64-unknown-linux-gnu.tgz
          chmod +x jpreprocess/dict_tools
          jpreprocess/dict_tools build jpreprocess naist-jdic-source naist-jdic
      - name: Package naist-jdic
        run: |
          tar czvf naist-jdic-jpreprocess.tar.gz naist-jdic
      - name: Upload Artifact
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: naist-jdic
          path: naist-jdic-jpreprocess.tar.gz

  generate-prebuilt-json:
    runs-on: ubuntu-latest
    needs: [build-naist-jdic]
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Download naist-jdic artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: naist-jdic
      - name: Generate prebuilt.json
        run: |
          URL="https://github.com/jpreprocess/jpreprocess/releases/download/${{ github.ref_name }}/naist-jdic-jpreprocess.tar.gz"
          MD5HASH=$(md5sum naist-jdic-jpreprocess.tar.gz | awk '{ print $1 }')
          echo "{\"url\": \"$URL\", \"digest\": \"$MD5HASH\"}" > prebuilt.json
      - name: Upload prebuilt.json
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874 # v4.4.0
        with:
          name: prebuilt-json
          path: prebuilt.json

  publish-crates:
    runs-on: ubuntu-latest
    needs: [pre-publish-test, check-prerelease, generate-prebuilt-json]
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: Download prebuilt.json artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: prebuilt-json
          path: crates/jpreprocess-naist-jdic
      - name: Show prebuilt.json
        run: cat crates/jpreprocess-naist-jdic/prebuilt.json
      - name: Publish crates
        if: needs.check-prerelease.outputs.release == 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: cargo publish --all-features
      - name: Publish crates (dry run)
        if: needs.check-prerelease.outputs.release == 'false'
        run: cargo publish --all-features --dry-run

  create-release:
    name: Create Release
    permissions:
      contents: write
    needs: [pre-publish-test, check-prerelease, build-binary, build-naist-jdic]
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
      - name: Create release
        uses: "marvinpinto/action-automatic-releases@latest"
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: ${{ needs.check-prerelease.outputs.release == 'false' }}
          files: |
            **/*.tar.gz
            **/*.tgz
